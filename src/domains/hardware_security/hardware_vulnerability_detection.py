"""
Hardware Vulnerability Detection Module
Analyzes HDL/Verilog code for security vulnerabilities
"""

from typing import List, Dict, Any, Optional
from dataclasses import dataclass
from datetime import datetime

from src.utils.llm_client import LLMClient
from src.utils.logger import get_logger

logger = get_logger(__name__)


@dataclass
class HardwareVulnerability:
    """Hardware vulnerability finding"""

    vuln_id: str
    severity: str  # CRITICAL, HIGH, MEDIUM, LOW
    category: str
    title: str
    description: str
    affected_module: str
    line_numbers: List[int]
    cwe_id: Optional[str]
    impact: str
    remediation: str


@dataclass
class HardwareAudit:
    """Hardware security audit report"""

    design_name: str
    audit_id: str
    timestamp: str
    security_score: float
    vulnerabilities: List[HardwareVulnerability]
    design_weaknesses: List[str]
    recommendations: List[str]
    overall_risk: str


class HardwareVulnerabilityDetectionModule:
    """
    Hardware Vulnerability Detection Module
    Analyzes HDL/Verilog for security vulnerabilities
    """

    def __init__(self):
        """Initialize hardware vulnerability detection module"""
        self.llm_client = LLMClient()
        logger.info("Hardware Vulnerability Detection Module initialized")

    def analyze_hdl_code(self, hdl_code: str, design_name: str = "Hardware Design") -> HardwareAudit:
        """
        Analyze HDL/Verilog code for vulnerabilities

        Args:
            hdl_code: HDL/Verilog source code
            design_name: Name of the hardware design

        Returns:
            HardwareAudit: Security audit report
        """
        logger.info(f"Analyzing hardware design: {design_name}")

        system_message = """You are a hardware security expert specializing in RTL security.
Identify vulnerabilities in HDL/Verilog code:
- Side-channel vulnerabilities (timing, power)
- Hardware Trojans
- Information leakage
- Fault injection vulnerabilities
- Clock glitching susceptibility
- Power analysis weaknesses
- Cryptographic implementation flaws
- Access control bypass
- Debug interface exposure
- Scan chain vulnerabilities"""

        prompt = f"""Analyze this HDL code for security vulnerabilities:

Design: {design_name}

```verilog
{hdl_code[:2500]}
```

Provide security audit in JSON format:
{{
    "security_score": float (0-100),
    "overall_risk": "CRITICAL" | "HIGH" | "MEDIUM" | "LOW",
    "vulnerabilities": [
        {{
            "severity": "CRITICAL" | "HIGH" | "MEDIUM" | "LOW",
            "category": "side_channel" | "trojan" | "info_leak" | "fault_injection" | "crypto" | "access_control",
            "title": "brief title",
            "description": "detailed description",
            "affected_module": "module name",
            "line_numbers": [affected lines],
            "cwe_id": "CWE-XXX or null",
            "impact": "security impact",
            "remediation": "how to fix"
        }}
    ],
    "design_weaknesses": [list of design weaknesses],
    "recommendations": [list of security improvements]
}}"""

        try:
            result = self.llm_client.complete_with_json(prompt, system_message=system_message)

            audit_id = f"hw_audit_{datetime.now().timestamp()}"

            vulnerabilities = []
            for vuln in result.get("vulnerabilities", []):
                vulnerabilities.append(
                    HardwareVulnerability(
                        vuln_id=f"hw_vuln_{len(vulnerabilities)}",
                        severity=vuln.get("severity", "MEDIUM"),
                        category=vuln.get("category", "unknown"),
                        title=vuln.get("title", ""),
                        description=vuln.get("description", ""),
                        affected_module=vuln.get("affected_module", ""),
                        line_numbers=vuln.get("line_numbers", []),
                        cwe_id=vuln.get("cwe_id"),
                        impact=vuln.get("impact", ""),
                        remediation=vuln.get("remediation", ""),
                    )
                )

            return HardwareAudit(
                design_name=design_name,
                audit_id=audit_id,
                timestamp=datetime.now().isoformat(),
                security_score=result.get("security_score", 0.0),
                vulnerabilities=vulnerabilities,
                design_weaknesses=result.get("design_weaknesses", []),
                recommendations=result.get("recommendations", []),
                overall_risk=result.get("overall_risk", "UNKNOWN"),
            )

        except Exception as e:
            logger.error(f"Hardware analysis failed: {e}")
            return HardwareAudit(
                design_name=design_name,
                audit_id="error",
                timestamp=datetime.now().isoformat(),
                security_score=0.0,
                vulnerabilities=[],
                design_weaknesses=[],
                recommendations=[f"Analysis error: {e}"],
                overall_risk="UNKNOWN",
            )

    def detect_hardware_trojans(self, hdl_code: str) -> Dict[str, Any]:
        """
        Detect potential hardware Trojans

        Args:
            hdl_code: HDL code to analyze

        Returns:
            Dict: Trojan detection results
        """
        logger.info("Detecting hardware Trojans")

        system_message = """You are a hardware Trojan detection expert.
Identify suspicious patterns that may indicate Trojans:
- Unused or rarely triggered logic
- Suspicious state machines
- Hidden backdoors
- Anomalous signal dependencies
- Payload circuits
- Trigger mechanisms"""

        prompt = f"""Analyze this HDL code for hardware Trojans:

```verilog
{hdl_code[:2000]}
```

Provide analysis in JSON format:
{{
    "trojan_detected": boolean,
    "confidence": float (0-1),
    "trojan_type": "trigger" | "payload" | "combined" | "none",
    "suspicious_modules": [list of suspicious module names],
    "indicators": [list of trojan indicators],
    "trigger_analysis": "description of trigger mechanism",
    "payload_analysis": "description of payload",
    "recommendations": [list of recommendations]
}}"""

        try:
            result = self.llm_client.complete_with_json(prompt, system_message=system_message)
            return {
                "timestamp": datetime.now().isoformat(),
                **result
            }
        except Exception as e:
            logger.error(f"Trojan detection failed: {e}")
            return {"error": str(e), "trojan_detected": False}

    def analyze_side_channels(self, hdl_code: str) -> Dict[str, Any]:
        """
        Analyze design for side-channel vulnerabilities

        Args:
            hdl_code: HDL code to analyze

        Returns:
            Dict: Side-channel analysis
        """
        logger.info("Analyzing side-channel vulnerabilities")

        system_message = """You are a side-channel analysis expert.
Identify side-channel vulnerabilities:
- Timing side-channels (data-dependent timing)
- Power side-channels (data-dependent power consumption)
- Electromagnetic emanations
- Cache timing attacks
- Branch prediction leakage"""

        prompt = f"""Analyze this hardware design for side-channel vulnerabilities:

```verilog
{hdl_code[:2000]}
```

Provide analysis in JSON format:
{{
    "vulnerable_to_side_channels": boolean,
    "timing_leakage": boolean,
    "power_leakage": boolean,
    "vulnerable_operations": [list of operations that leak],
    "severity": "CRITICAL" | "HIGH" | "MEDIUM" | "LOW",
    "countermeasures": [list of recommended countermeasures]
}}"""

        try:
            result = self.llm_client.complete_with_json(prompt, system_message=system_message)
            return {
                "timestamp": datetime.now().isoformat(),
                **result
            }
        except Exception as e:
            logger.error(f"Side-channel analysis failed: {e}")
            return {"error": str(e), "vulnerable_to_side_channels": False}


# Example usage
if __name__ == "__main__":
    detector = HardwareVulnerabilityDetectionModule()

    verilog_code = """
    module crypto_engine (
        input clk,
        input [127:0] key,
        input [127:0] plaintext,
        output reg [127:0] ciphertext
    );
        always @(posedge clk) begin
            // Vulnerable: data-dependent timing
            if (key[0] == 1'b1) begin
                ciphertext <= plaintext ^ key;
            end else begin
                ciphertext <= plaintext;
            end
        end
    endmodule
    """

    print("=" * 70)
    print("HARDWARE SECURITY AUDIT")
    print("=" * 70)

    audit = detector.analyze_hdl_code(verilog_code, "CryptoEngine")
    print(f"Design: {audit.design_name}")
    print(f"Security Score: {audit.security_score:.1f}/100")
    print(f"Overall Risk: {audit.overall_risk}")
    print(f"Vulnerabilities: {len(audit.vulnerabilities)}")

    print("\n" + "=" * 70)
    print("HARDWARE TROJAN DETECTION")
    print("=" * 70)

    trojan_result = detector.detect_hardware_trojans(verilog_code)
    print(f"Trojan Detected: {trojan_result.get('trojan_detected', False)}")
    print(f"Confidence: {trojan_result.get('confidence', 0):.2f}")
