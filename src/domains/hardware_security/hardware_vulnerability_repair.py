"""
Hardware Vulnerability Repair Module
Generates security assertions and fixes for HDL code
"""

from typing import List, Dict, Any, Optional
from dataclasses import dataclass
from datetime import datetime

from src.utils.llm_client import LLMClient
from src.utils.logger import get_logger

logger = get_logger(__name__)


@dataclass
class SecurityAssertion:
    """Security assertion for hardware"""

    assertion_id: str
    assertion_type: str
    property_name: str
    svassert_code: str
    description: str
    purpose: str


@dataclass
class HardwarePatch:
    """Hardware security patch"""

    patch_id: str
    vulnerability_fixed: str
    original_code: str
    patched_code: str
    explanation: str
    assertions_added: List[SecurityAssertion]


class HardwareVulnerabilityRepairModule:
    """
    Hardware Vulnerability Repair Module
    Generates security assertions and patches for hardware designs
    """

    def __init__(self):
        """Initialize hardware repair module"""
        self.llm_client = LLMClient()
        logger.info("Hardware Vulnerability Repair Module initialized")

    def generate_security_assertions(
        self, hdl_code: str, security_properties: List[str]
    ) -> List[SecurityAssertion]:
        """
        Generate SystemVerilog assertions for security properties

        Args:
            hdl_code: HDL code
            security_properties: Security properties to assert

        Returns:
            List[SecurityAssertion]: Generated assertions
        """
        logger.info(f"Generating security assertions for {len(security_properties)} properties")

        system_message = """You are a hardware verification expert specializing in security assertions.
Generate SystemVerilog assertions (SVA) for security properties:
- Information flow security
- Access control properties
- Timing invariants
- State machine safety
- Data integrity
- Confidentiality properties"""

        props_str = "\n".join(f"- {prop}" for prop in security_properties)

        prompt = f"""Generate SystemVerilog assertions for these security properties:

HDL Code:
```verilog
{hdl_code[:2000]}
```

Security Properties:
{props_str}

Generate assertions in JSON format:
{{
    "assertions": [
        {{
            "assertion_type": "immediate" | "concurrent" | "property",
            "property_name": "descriptive property name",
            "svassert_code": "SystemVerilog assertion code",
            "description": "what this assertion checks",
            "purpose": "security purpose of this assertion"
        }}
    ]
}}"""

        try:
            result = self.llm_client.complete_with_json(prompt, system_message=system_message)

            assertions = []
            for assertion in result.get("assertions", []):
                assertions.append(
                    SecurityAssertion(
                        assertion_id=f"assert_{len(assertions)}",
                        assertion_type=assertion.get("assertion_type", "property"),
                        property_name=assertion.get("property_name", ""),
                        svassert_code=assertion.get("svassert_code", ""),
                        description=assertion.get("description", ""),
                        purpose=assertion.get("purpose", ""),
                    )
                )

            logger.info(f"Generated {len(assertions)} security assertions")
            return assertions

        except Exception as e:
            logger.error(f"Assertion generation failed: {e}")
            return []

    def patch_vulnerability(
        self, vulnerable_code: str, vulnerability_description: str
    ) -> HardwarePatch:
        """
        Generate patch for hardware vulnerability

        Args:
            vulnerable_code: Vulnerable HDL code
            vulnerability_description: Description of vulnerability

        Returns:
            HardwarePatch: Security patch
        """
        logger.info("Generating security patch")

        system_message = """You are a hardware security engineer.
Generate secure patches for hardware vulnerabilities.
Ensure: constant-time operations, side-channel resistance, proper access control."""

        prompt = f"""Generate a security patch for this vulnerable hardware code:

Vulnerability: {vulnerability_description}

Vulnerable Code:
```verilog
{vulnerable_code}
```

Provide patch in JSON format:
{{
    "patched_code": "complete patched Verilog code",
    "explanation": "detailed explanation of changes",
    "assertions": [
        {{
            "assertion_type": "property",
            "property_name": "property name",
            "svassert_code": "assertion code",
            "description": "assertion description",
            "purpose": "security purpose"
        }}
    ]
}}"""

        try:
            result = self.llm_client.complete_with_json(prompt, system_message=system_message)

            patch_id = f"patch_{datetime.now().timestamp()}"

            assertions = []
            for assertion in result.get("assertions", []):
                assertions.append(
                    SecurityAssertion(
                        assertion_id=f"assert_{len(assertions)}",
                        assertion_type=assertion.get("assertion_type", "property"),
                        property_name=assertion.get("property_name", ""),
                        svassert_code=assertion.get("svassert_code", ""),
                        description=assertion.get("description", ""),
                        purpose=assertion.get("purpose", ""),
                    )
                )

            return HardwarePatch(
                patch_id=patch_id,
                vulnerability_fixed=vulnerability_description,
                original_code=vulnerable_code,
                patched_code=result.get("patched_code", ""),
                explanation=result.get("explanation", ""),
                assertions_added=assertions,
            )

        except Exception as e:
            logger.error(f"Patch generation failed: {e}")
            return HardwarePatch(
                patch_id="error",
                vulnerability_fixed=vulnerability_description,
                original_code=vulnerable_code,
                patched_code="",
                explanation=f"Patch generation error: {e}",
                assertions_added=[],
            )


# Example usage
if __name__ == "__main__":
    repair = HardwareVulnerabilityRepairModule()

    vulnerable_code = """
    always @(posedge clk) begin
        if (key[0]) ciphertext <= plaintext ^ key;
        else ciphertext <= plaintext;
    end
    """

    print("=" * 70)
    print("HARDWARE VULNERABILITY REPAIR")
    print("=" * 70)

    patch = repair.patch_vulnerability(vulnerable_code, "Timing side-channel in crypto")
    print(f"Patch ID: {patch.patch_id}")
    print(f"Vulnerability: {patch.vulnerability_fixed}")
    print(f"Assertions Added: {len(patch.assertions_added)}")
    print(f"\nPatched Code:\n{patch.patched_code[:200]}...")
