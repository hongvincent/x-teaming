"""
Firmware Vulnerability Detection Module
Analyzes IoT firmware for security vulnerabilities
"""

from typing import List, Dict, Any
from dataclasses import dataclass
from datetime import datetime

from src.utils.llm_client import LLMClient
from src.utils.logger import get_logger

logger = get_logger(__name__)


@dataclass
class FirmwareVulnerability:
    """Firmware vulnerability finding"""

    vuln_id: str
    severity: str
    category: str
    description: str
    affected_component: str
    cve_id: str
    remediation: str


@dataclass
class FirmwareAnalysisReport:
    """Firmware security analysis report"""

    firmware_id: str
    device_type: str
    analysis_id: str
    timestamp: str
    security_score: float
    vulnerabilities: List[FirmwareVulnerability]
    hardcoded_credentials: List[str]
    backdoors_detected: bool
    encryption_issues: List[str]
    recommendations: List[str]


class FirmwareVulnerabilityDetectionModule:
    """
    Firmware Vulnerability Detection Module
    Analyzes IoT firmware binaries for security issues
    """

    def __init__(self):
        """Initialize firmware vulnerability detection module"""
        self.llm_client = LLMClient()
        logger.info("Firmware Vulnerability Detection Module initialized")

    def analyze_firmware(
        self, firmware_info: Dict[str, Any], binary_analysis: Dict[str, Any]
    ) -> FirmwareAnalysisReport:
        """
        Analyze IoT firmware for vulnerabilities

        Args:
            firmware_info: Firmware metadata
            binary_analysis: Binary analysis results

        Returns:
            FirmwareAnalysisReport: Security analysis report
        """
        logger.info(f"Analyzing firmware: {firmware_info.get('device', 'unknown')}")

        system_message = """You are an IoT security expert specializing in firmware analysis.
Identify firmware vulnerabilities:
- Hardcoded credentials
- Backdoors and hidden functionality
- Buffer overflows
- Weak encryption
- Insecure update mechanisms
- Debug interfaces
- Known CVEs"""

        firmware_str = "\n".join([f"{k}: {v}" for k, v in firmware_info.items()])
        binary_str = "\n".join([f"{k}: {v}" for k, v in binary_analysis.items()])

        prompt = f"""Analyze this IoT firmware for security vulnerabilities:

Firmware Info:
{firmware_str}

Binary Analysis:
{binary_str}

Provide security analysis in JSON format:
{{
    "security_score": float (0-100),
    "vulnerabilities": [
        {{
            "severity": "CRITICAL" | "HIGH" | "MEDIUM" | "LOW",
            "category": "credentials" | "backdoor" | "buffer_overflow" | "crypto" | "update",
            "description": "vulnerability description",
            "affected_component": "component name",
            "cve_id": "CVE-XXXX-XXXX or empty",
            "remediation": "fix recommendation"
        }}
    ],
    "hardcoded_credentials": [list of found credentials],
    "backdoors_detected": boolean,
    "encryption_issues": [encryption problems found],
    "recommendations": [security recommendations]
}}"""

        try:
            result = self.llm_client.complete_with_json(prompt, system_message=system_message)

            vulnerabilities = []
            for vuln in result.get("vulnerabilities", []):
                vulnerabilities.append(
                    FirmwareVulnerability(
                        vuln_id=f"fw_vuln_{len(vulnerabilities)}",
                        severity=vuln.get("severity", "MEDIUM"),
                        category=vuln.get("category", "unknown"),
                        description=vuln.get("description", ""),
                        affected_component=vuln.get("affected_component", ""),
                        cve_id=vuln.get("cve_id", ""),
                        remediation=vuln.get("remediation", ""),
                    )
                )

            return FirmwareAnalysisReport(
                firmware_id=firmware_info.get("id", "unknown"),
                device_type=firmware_info.get("device", "unknown"),
                analysis_id=f"fw_analysis_{datetime.now().timestamp()}",
                timestamp=datetime.now().isoformat(),
                security_score=result.get("security_score", 0.0),
                vulnerabilities=vulnerabilities,
                hardcoded_credentials=result.get("hardcoded_credentials", []),
                backdoors_detected=result.get("backdoors_detected", False),
                encryption_issues=result.get("encryption_issues", []),
                recommendations=result.get("recommendations", []),
            )

        except Exception as e:
            logger.error(f"Firmware analysis failed: {e}")
            return FirmwareAnalysisReport(
                firmware_id="error",
                device_type="unknown",
                analysis_id="error",
                timestamp=datetime.now().isoformat(),
                security_score=0.0,
                vulnerabilities=[],
                hardcoded_credentials=[],
                backdoors_detected=False,
                encryption_issues=[],
                recommendations=[f"Analysis error: {e}"],
            )


# Example usage
if __name__ == "__main__":
    detector = FirmwareVulnerabilityDetectionModule()

    firmware_info = {
        "id": "FW-2024-001",
        "device": "Smart Camera",
        "version": "1.2.3",
        "manufacturer": "IoT Corp",
    }

    binary_analysis = {
        "strings_found": ["admin:admin", "root:password", "telnet enabled"],
        "open_ports": [23, 80, 8080],
        "encryption": "DES (deprecated)",
        "update_mechanism": "HTTP (unencrypted)",
    }

    print("=" * 70)
    print("FIRMWARE VULNERABILITY ANALYSIS")
    print("=" * 70)

    report = detector.analyze_firmware(firmware_info, binary_analysis)
    print(f"Device: {report.device_type}")
    print(f"Security Score: {report.security_score:.1f}/100")
    print(f"Vulnerabilities: {len(report.vulnerabilities)}")
    print(f"Hardcoded Credentials: {len(report.hardcoded_credentials)}")
    print(f"Backdoors Detected: {report.backdoors_detected}")
